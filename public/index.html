<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title data-lang-en="Academic Teacher Evaluation System" data-lang-fr="Système d'Évaluation Académique des Enseignants">Academic Teacher Evaluation System</title>
    <link rel="stylesheet" href="styles.css">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <!-- Word Document Generation Libraries -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/docx/7.5.0/docx.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
</head>
<body>

    <div class="container">
        <!-- School Logo -->
        <div class="school-logo">
            <img src="https://lh3.googleusercontent.com/d/1lQ3Babrs3Wgv4rakVmkK0oCWcM0cTKPK" alt="School Logo" />
        </div>

        <!-- Professional Header Controls -->
        <div class="header-controls">
            <div class="language-switcher">
                <button id="lang-en" class="lang-btn active">
                    <i class="fas fa-globe"></i> EN
                </button>
                <button id="lang-fr" class="lang-btn">
                    <i class="fas fa-globe"></i> FR
                </button>
            </div>
            <button id="settings-btn" class="settings-btn" style="display: none;">
                <i class="fas fa-cog"></i> <span data-lang-en="Settings" data-lang-fr="Paramètres">Settings</span>
            </button>
        </div>
        
        <!-- Settings Panel -->
        <div id="settings-panel" class="settings-panel">
            <div class="settings-content">
                <div class="settings-header">
                    <h3 data-lang-en="System Settings" data-lang-fr="Paramètres Système">System Settings</h3>
                    <button id="close-settings" class="close-btn">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                <div class="settings-form">
                    <div class="setting-group">
                        <label for="school-name-input" data-lang-en="School/Institution Name" data-lang-fr="Nom de l'École/Institution">School/Institution Name</label>
                        <input type="text" id="school-name-input" placeholder-en="Enter school name..." placeholder-fr="Entrez le nom de l'école...">
                    </div>
                    <div class="setting-group">
                        <label for="logo-url-input" data-lang-en="Logo URL" data-lang-fr="URL du Logo">Logo URL</label>
                        <input type="url" id="logo-url-input" placeholder="https://example.com/logo.png">
                    </div>
                    <button id="save-settings" class="save-btn" data-lang-en="Save Settings" data-lang-fr="Enregistrer">Save Settings</button>
                </div>
            </div>
        </div>

        <!-- Login Page -->
        <div id="login-page" class="page active">
            <div class="card">
                <h1 data-lang-en="Login" data-lang-fr="Connexion">Login</h1>
                <form id="login-form">
                    <input type="text" id="username" placeholder-en="Username" placeholder-fr="Nom d'utilisateur" required>
                    <div class="password-container">
                        <input type="password" id="password" placeholder-en="Password" placeholder-fr="Mot de passe" required>
                        <button type="button" id="toggle-password" class="password-toggle" aria-label="Show password">
                            <i class="fas fa-eye"></i>
                        </button>
                    </div>
                    <div class="checkbox-container">
                        <input type="checkbox" id="remember-me">
                        <label for="remember-me" data-lang-en="Remember me" data-lang-fr="Rester connecté">Remember me</label>
                    </div>
                    <button type="submit" data-lang-en="Login" data-lang-fr="Se connecter">Login</button>
                </form>
                <p id="login-error" class="error-message"></p>
                <div class="login-help">
                    <p data-lang-en="Please contact your system administrator for login credentials." data-lang-fr="Veuillez contacter votre administrateur système pour les identifiants.">Please contact your system administrator for login credentials.</p>
                </div>
            </div>
        </div>

        <!-- Coordinator Dashboard -->
        <div id="coordinator-dashboard" class="page">
            <h1 data-lang-en="Coordinator Dashboard" data-lang-fr="Tableau de Bord Coordinateur">Coordinator Dashboard</h1>
            <h2 id="coordinator-welcome"></h2>
            <div class="card">
                <h3 data-lang-en="Select a teacher to evaluate:" data-lang-fr="Sélectionnez un enseignant à évaluer :">Select a teacher to evaluate:</h3>
                <select id="teacher-select"></select>
            </div>
            <div id="previous-evaluations-container"></div>
            <div id="evaluation-form-container"></div>
            <button id="logout-btn"><i class="fas fa-sign-out-alt"></i> <span data-lang-en="Logout" data-lang-fr="Déconnexion">Logout</span></button>
        </div>

        <!-- Teacher Dashboard -->
        <div id="teacher-dashboard" class="page">
            <h1 data-lang-en="Teacher Dashboard" data-lang-fr="Tableau de Bord Enseignant">Teacher Dashboard</h1>
            <h2 id="teacher-welcome"></h2>
            <div id="evaluation-reports"></div>
            <button id="logout-btn-teacher"><i class="fas fa-sign-out-alt"></i> <span data-lang-en="Logout" data-lang-fr="Déconnexion">Logout</span></button>
        </div>
        
        <!-- Modal for Evaluation Details -->
        <div id="details-modal" class="modal">
            <div class="modal-content">
                <div class="modal-header">
                    <h2 data-lang-en="Evaluation Details" data-lang-fr="Détails de l'Évaluation">Evaluation Details</h2>
                    <button class="close-btn" id="close-modal-btn"><i class="fas fa-times"></i></button>
                </div>
                <div class="modal-body" id="modal-body-content">
                    <!-- Detailed content will be injected here -->
                </div>
            </div>
        </div>

    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const state = { currentUser: null, currentLang: 'en' };
            const pages = {
                login: document.getElementById('login-page'),
                coordinator: document.getElementById('coordinator-dashboard'),
                teacher: document.getElementById('teacher-dashboard')
            };
            
            let EVALUATIONS_DATABASE = [];

            function saveEvaluationsToStorage() {
                localStorage.setItem('evaluationsDatabase', JSON.stringify(EVALUATIONS_DATABASE));
            }

            function loadEvaluationsFromStorage() {
                const storedData = localStorage.getItem('evaluationsDatabase');
                if (storedData) { EVALUATIONS_DATABASE = JSON.parse(storedData); }
            }
            
            loadEvaluationsFromStorage();

            const langElements = document.querySelectorAll('[data-lang-en], [data-lang-fr]');
            const placeholderElements = document.querySelectorAll('[placeholder-en], [placeholder-fr]');

            function setLanguage(lang) {
                state.currentLang = lang;
                document.documentElement.lang = lang;
                langElements.forEach(el => {
                    const text = el.dataset[`lang-${lang}`];
                    if (text) {
                        const icon = el.querySelector('i');
                        if (icon) {
                            const span = el.querySelector('span') || document.createElement('span');
                            span.textContent = ` ${text}`;
                            el.innerHTML = icon.outerHTML + span.outerHTML;
                        } else {
                            el.textContent = text;
                        }
                    }
                    if(el.tagName === 'TITLE') document.title = el.dataset[`lang-${lang}`];
                });
                placeholderElements.forEach(el => {
                    el.placeholder = el.getAttribute(`placeholder-${lang}`);
                });
                document.getElementById('lang-en').classList.toggle('active', lang === 'en');
                document.getElementById('lang-fr').classList.toggle('active', lang === 'fr');
            }

            document.getElementById('lang-en').addEventListener('click', () => setLanguage('en'));
            document.getElementById('lang-fr').addEventListener('click', () => setLanguage('fr'));

            document.getElementById('toggle-password').addEventListener('click', function() {
                const passwordInput = document.getElementById('password');
                const passwordIcon = this.querySelector('i');
                if (passwordInput.type === 'password') {
                    passwordInput.type = 'text';
                    passwordIcon.classList.replace('fa-eye', 'fa-eye-slash');
                } else {
                    passwordInput.type = 'password';
                    passwordIcon.classList.replace('fa-eye-slash', 'fa-eye');
                }
            });

            function loadSavedCredentials() {
                const saved = localStorage.getItem('teacherEvaluationCredentials');
                if (saved) {
                    const { username, password, rememberMe } = JSON.parse(saved);
                    if (rememberMe) {
                        document.getElementById('username').value = username;
                        document.getElementById('password').value = password;
                        document.getElementById('remember-me').checked = true;
                    }
                }
            }
            function saveCredentials(username, password, rememberMe) {
                if (rememberMe) {
                    localStorage.setItem('teacherEvaluationCredentials', JSON.stringify({ username, password, rememberMe }));
                } else {
                    localStorage.removeItem('teacherEvaluationCredentials');
                }
            }
            loadSavedCredentials();

            function showPage(pageName) {
                Object.values(pages).forEach(page => page.classList.remove('active'));
                pages[pageName].classList.add('active');
            }

            const USERS_DATABASE = [
                { username: 'Mohamed', password: 'Mohamed@86', role: 'coordinator', assignedTeachers: ['Morched', 'Kamel', 'Abas', 'Zine', 'Youssef', 'Oumarou', 'Tonga', 'Sylvano', 'Sami', 'Mohamed Ali'] },
                { username: 'Zohra', password: 'Zohra@40', role: 'coordinator', assignedTeachers: ['Aichetou', 'Inas', 'Anwar', 'Souha', 'Amal', 'Shanouja', 'Jana', 'Hiba'] },
                { username: 'Rasha', password: 'Rasha@26', role: 'coordinator', assignedTeachers: ['Amal', 'Rouba', 'Rayan', 'Imane', 'Nesrine', 'Fatima', 'Samar', 'Romana', 'Nour'] },
                ...['Morched', 'Kamel', 'Abas', 'Zine', 'Youssef', 'Oumarou', 'Tonga', 'Sylvano', 'Sami', 'Mohamed Ali', 'Aichetou', 'Inas', 'Anwar', 'Souha', 'Amal', 'Shanouja', 'Jana', 'Hiba', 'Rouba', 'Rayan', 'Imane', 'Nesrine', 'Fatima', 'Samar', 'Romana', 'Nour'].map(name => ({ username: name, password: name, role: 'teacher' }))
            ];
            

            document.getElementById('login-form').addEventListener('submit', (e) => {
                e.preventDefault();
                const username = document.getElementById('username').value;
                const password = document.getElementById('password').value;
                const user = USERS_DATABASE.find(u => u.username === username && u.password === password);
                
                if (user) {
                    saveCredentials(username, password, document.getElementById('remember-me').checked);
                    state.currentUser = user;
                    if (user.role === 'coordinator') {
                        renderCoordinatorDashboard();
                        showPage('coordinator');
                    } else {
                        renderTeacherDashboard();
                        showPage('teacher');
                    }
                    document.getElementById('login-error').textContent = '';
                } else {
                    document.getElementById('login-error').textContent = state.currentLang === 'fr' ? 'Identifiants invalides' : 'Invalid credentials';
                }
            });
            
            function logout() {
                state.currentUser = null;
                document.getElementById('login-form').reset();
                showPage('login');
            }
            document.getElementById('logout-btn').addEventListener('click', logout);
            document.getElementById('logout-btn-teacher').addEventListener('click', logout);

            function renderCoordinatorDashboard() {
                document.getElementById('coordinator-welcome').textContent = `${state.currentLang === 'fr' ? 'Bienvenue' : 'Welcome'}, ${state.currentUser.username}`;
                const teacherSelect = document.getElementById('teacher-select');
                teacherSelect.innerHTML = `<option value="">${state.currentLang === 'fr' ? 'Choisir un enseignant...' : 'Choose a teacher...'}</option>`;
                state.currentUser.assignedTeachers.sort().forEach(teacher => {
                    teacherSelect.innerHTML += `<option value="${teacher}">${teacher}</option>`;
                });
                
                document.getElementById('settings-btn').style.display = 'inline-flex';
                window.initSettingsPanel();
            }

            document.getElementById('teacher-select').addEventListener('change', (e) => {
                const teacherName = e.target.value;
                document.getElementById('evaluation-form-container').innerHTML = '';
                document.getElementById('previous-evaluations-container').innerHTML = '';
                if (teacherName) {
                    renderPreviousEvaluations(teacherName);
                    renderEvaluationForm(teacherName);
                }
            });
            
            function renderPreviousEvaluations(teacherName) {
                const container = document.getElementById('previous-evaluations-container');
                const previousEvals = EVALUATIONS_DATABASE.filter(e => e.teacherName === teacherName);
                if(previousEvals.length === 0) return;

                let listHTML = `<div class="card">
                    <h3 data-lang-en="Previous Evaluations for ${teacherName}" data-lang-fr="Évaluations Précédentes pour ${teacherName}"></h3>
                    <ul class="previous-eval-list">`;
                previousEvals.sort((a,b) => new Date(b.date) - new Date(a.date)).forEach(ev => {
                    listHTML += `<li>
                        <span>
                            <i class="fas fa-calendar-alt"></i> ${new Date(ev.date).toLocaleDateString()}
                            - <b>Score:</b> ${ev.grandTotal}/100
                        </span>
                        <button class="view-btn" onclick="showEvaluationDetails('${ev.id}')">
                            <i class="fas fa-eye"></i> <span data-lang-en="View" data-lang-fr="Voir"></span>
                        </button>
                    </li>`;
                });
                container.innerHTML = listHTML + `</ul></div>`;
                setLanguage(state.currentLang);
            }

            function renderEvaluationForm(teacherName) {
                const visitNumber = EVALUATIONS_DATABASE.filter(e => e.teacherName === teacherName).length + 1;
                const criteria = getCriteria();

                let formHTML = `<form id="eval-form" class="card">
                    <h3><i class="fas fa-clipboard-list"></i> ${state.currentLang === 'fr' ? 'Nouvelle Évaluation pour' : 'New Evaluation for'} ${teacherName}</h3>
                    <div class="evaluation-metadata">
                        <div class="metadata-row">
                             <div class="metadata-item">
                                <label for="visit-number">${state.currentLang === 'fr' ? 'Numéro de Visite' : 'Visit Number'}:</label>
                                <input type="text" id="visit-number" name="visitNumber" value="${visitNumber}" readonly>
                            </div>
                            <div class="metadata-item">
                                <label for="visit-date">${state.currentLang === 'fr' ? 'Date de Visite' : 'Visit Date'}:</label>
                                <input type="date" id="visit-date" name="visitDate" required value="${new Date().toISOString().split('T')[0]}">
                            </div>
                             <div class="metadata-item">
                                <label for="session-number">${state.currentLang === 'fr' ? 'Numéro de Séance' : 'Session Number'}:</label>
                                <select id="session-number" name="sessionNumber" required>${Array.from({length: 8}, (_, i) => `<option value="${i+1}">${i+1}</option>`).join('')}</select>
                            </div>
                            <div class="metadata-item">
                                <label for="subject-field">${state.currentLang === 'fr' ? 'Matière' : 'Subject'}:</label>
                                <input type="text" id="subject-field" name="subject" required placeholder="${state.currentLang === 'fr' ? 'Ex: Mathématiques' : 'Ex: Mathematics'}">
                            </div>
                        </div>
                    </div>`;

                let criteriaIndex = 0;
                for(const category in criteria) {
                    const cat = criteria[category];
                    formHTML += `<fieldset class="criteria-section">
                            <legend class="category-header">
                                <span class="category-title">${cat[`title_${state.currentLang}`]}</span>
                                <span class="category-points"><span class="current-score" data-category="${category}">0</span>/${cat.maxPoints} pts</span>
                            </legend>
                            <div class="criteria-table"><div class="table-header"><div class="criteria-col">${state.currentLang==='fr'?'Critères':'Criteria'}</div><div class="points-col">${state.currentLang==='fr'?'Points':'Points'}</div><div class="rating-col">${state.currentLang==='fr'?'Éval.':'Rating'}</div><div class="score-col">Score</div></div>`;
                    cat.items.forEach(item => {
                        formHTML += `<div class="criteria-row">
                                <div class="criteria-text">${item[`text_${state.currentLang}`]}</div>
                                <div class="max-points">${item.points}</div>
                                <div class="rating-controls">${[1,2,3,4,5].map(n => `<input type="radio" id="c${criteriaIndex}-${n}" name="crit${criteriaIndex}" value="${n}" data-max-points="${item.points}" data-category="${category}" required><label for="c${criteriaIndex}-${n}">${n}</label>`).join('')}</div>
                                <div class="calculated-score" data-criteria="${criteriaIndex}">0</div>
                            </div>`;
                        criteriaIndex++;
                    });
                    formHTML += `</div></fieldset>`;
                }
                
                formHTML += `<div class="evaluation-summary"><div class="total-score-section"><div class="score-display"><span class="total-number" id="grand-total-display">0</span><span class="total-max">/100</span></div><div class="performance-level" id="performance-level"></div></div></div>
                    <div class="comments-section">
                        <div class="comment-group"><label for="s"><i class="fas fa-star"></i> ${state.currentLang==='fr'?'Forces':'Strengths'}</label><textarea id="s" name="strengths" required></textarea></div>
                        <div class="comment-group"><label for="i"><i class="fas fa-arrow-up"></i> ${state.currentLang==='fr'?'Améliorations':'Improvements'}</label><textarea id="i" name="toImprove" required></textarea></div>
                        <div class="comment-group"><label for="r"><i class="fas fa-lightbulb"></i> ${state.currentLang==='fr'?'Recommandations':'Recommendations'}</label><textarea id="r" name="recommendations" required></textarea></div>
                    </div>
                    <div class="form-actions">
                        <button type="button" id="generate-word-btn" class="word-btn" disabled><i class="fas fa-file-word"></i> ${state.currentLang==='fr'?'Générer Word':'Generate Word'}</button>
                        <button type="submit" class="submit-btn"><i class="fas fa-save"></i> ${state.currentLang==='fr'?'Enregistrer':'Save'}</button>
                    </div></form>`;

                const container = document.getElementById('evaluation-form-container');
                container.innerHTML = formHTML;
                
                function calculateScores() {
                    const ratings = container.querySelectorAll('input[type="radio"]:checked');
                    let grandTotal = 0;
                    const categoryTotals = Object.keys(criteria).reduce((acc, cat) => ({...acc, [cat]: 0}), {});
                    
                    ratings.forEach(rating => {
                        const weightedScore = Math.round((parseInt(rating.value) / 5) * parseInt(rating.dataset.maxPoints));
                        container.querySelector(`[data-criteria="${rating.name.replace('crit', '')}"]`).textContent = weightedScore;
                        categoryTotals[rating.dataset.category] += weightedScore;
                        grandTotal += weightedScore;
                    });
                    
                    Object.keys(categoryTotals).forEach(cat => { container.querySelector(`[data-category="${cat}"]`).textContent = categoryTotals[cat]; });
                    
                    document.getElementById('grand-total-display').textContent = grandTotal;
                    const performance = getPerformanceLevel(grandTotal);
                    const levelDisplay = document.getElementById('performance-level');
                    levelDisplay.textContent = performance[`label_${state.currentLang}`];
                    levelDisplay.style.color = performance.color;
                    
                    document.getElementById('generate-word-btn').disabled = ratings.length !== criteriaIndex;
                    return { grandTotal, categoryTotals, performance };
                }
                
                container.querySelector('#eval-form').addEventListener('change', calculateScores);
                
                container.querySelector('#generate-word-btn').addEventListener('click', () => {
                    const scores = calculateScores();
                    const formData = new FormData(container.querySelector('#eval-form'));
                    const rawCriteria = Array.from(container.querySelectorAll('input[type="radio"]:checked')).reduce((acc, r) => ({...acc, [r.name]: {rating: parseInt(r.value)}}), {});
                    generateWordDocument({
                        teacherName,
                        coordinatorName: state.currentUser.username,
                        subject: formData.get('subject'), sessionNumber: formData.get('sessionNumber'), visitDate: formData.get('visitDate'),
                        grandTotal: scores.grandTotal, performanceLevel: scores.performance,
                        criteriaDetails: criteria, rawCriteria,
                        comments: { strengths: formData.get('strengths'), toImprove: formData.get('toImprove'), recommendations: formData.get('recommendations') }
                    });
                });
                
                container.querySelector('#eval-form').addEventListener('submit', (e) => {
                    e.preventDefault();
                    if (container.querySelectorAll('input[type="radio"]:checked').length < criteriaIndex) {
                        alert(state.currentLang === 'fr' ? 'Veuillez noter tous les critères.' : 'Please rate all criteria.');
                        return;
                    }
                    const formData = new FormData(e.target);
                    const scores = calculateScores();
                    const rawCriteria = Array.from(container.querySelectorAll('input[type="radio"]:checked')).reduce((acc, r) => ({...acc, [r.name]: {rating: parseInt(r.value)}}), {});
                    
                    EVALUATIONS_DATABASE.push({
                        id: Date.now().toString(), teacherName, coordinatorName: state.currentUser.username,
                        subject: formData.get('subject'), sessionNumber: formData.get('sessionNumber'), visitDate: formData.get('visitDate'),
                        criteriaDetails: criteria, grandTotal: scores.grandTotal, categoryScores: scores.categoryTotals, performanceLevel: scores.performance,
                        comments: { strengths: formData.get('strengths'), toImprove: formData.get('toImprove'), recommendations: formData.get('recommendations') },
                        date: new Date().toISOString(), rawCriteria
                    });
                    saveEvaluationsToStorage();
                    alert(state.currentLang === 'fr' ? 'Évaluation enregistrée !' : 'Evaluation saved!');
                    document.getElementById('teacher-select').value = '';
                    container.innerHTML = '';
                    document.getElementById('previous-evaluations-container').innerHTML = '';
                });
            }

            function renderTeacherDashboard() {
                document.getElementById('teacher-welcome').textContent = `${state.currentLang === 'fr' ? 'Bienvenue' : 'Welcome'}, ${state.currentUser.username}`;
                const reportsContainer = document.getElementById('evaluation-reports');
                const evaluations = EVALUATIONS_DATABASE.filter(ev => ev.teacherName === state.currentUser.username);
                
                if (evaluations.length === 0) {
                    reportsContainer.innerHTML = `<div class="card no-evaluations"><h3>${state.currentLang === 'fr' ? 'Aucune évaluation' : 'No evaluations'}</h3></div>`; return;
                }
                
                reportsContainer.innerHTML = evaluations.sort((a, b) => new Date(b.date) - new Date(a.date)).map((ev, index) => `
                    <div class="evaluation-card ${index === 0 ? 'latest' : ''}">
                        <div class="card-header">
                            <div class="eval-date"><i class="fas fa-calendar-check"></i> ${new Date(ev.date).toLocaleDateString()} ${index === 0 ? `<span class="latest-badge">${state.currentLang === 'fr'?'RÉCENT':'LATEST'}</span>` : ''}</div>
                            <div class="eval-meta">${state.currentLang === 'fr'?'Évaluateur':'Evaluator'}: ${ev.coordinatorName}</div>
                        </div>
                        <div class="card-content">
                            <div class="overall-progress">
                                <div class="progress-bar-container"><div class="progress-bar-fill" style="width: ${ev.grandTotal}%; background-color: ${ev.performanceLevel.color};"></div></div>
                                <div class="score-summary">
                                    <span class="score-number">${ev.grandTotal}</span><span class="score-max">/100</span>
                                    <span class="performance-badge" style="background-color: ${ev.performanceLevel.color}">${ev.performanceLevel[`label_${state.currentLang}`]}</span>
                                </div>
                            </div>
                            <div class="card-actions">
                                <button class="details-btn" onclick="showEvaluationDetails('${ev.id}')"><i class="fas fa-search-plus"></i> ${state.currentLang === 'fr'?'Voir Détails':'View Details'}</button>
                            </div>
                        </div>
                    </div>`).join('');
            }
            
            const modal = document.getElementById('details-modal');
            document.getElementById('close-modal-btn').onclick = () => modal.style.display = "none";
            window.onclick = (e) => { if (e.target == modal) modal.style.display = "none"; }

            window.showEvaluationDetails = function(evalId) {
                const ev = EVALUATIONS_DATABASE.find(e => e.id === evalId);
                if (!ev) return;
                let critIndex = 0;
                document.getElementById('modal-body-content').innerHTML = `
                    <div class="detail-grid">
                        <div><strong>${state.currentLang === 'fr' ? 'Date' : 'Date'}:</strong> ${new Date(ev.date).toLocaleDateString()}</div>
                        <div><strong>${state.currentLang === 'fr' ? 'Évaluateur' : 'Evaluator'}:</strong> ${ev.coordinatorName}</div>
                        <div><strong>${state.currentLang === 'fr' ? 'Matière' : 'Subject'}:</strong> ${ev.subject}</div>
                        <div><strong>${state.currentLang === 'fr' ? 'Séance N°' : 'Session #'}:</strong> ${ev.sessionNumber}</div>
                    </div>
                    <h4>${state.currentLang === 'fr' ? 'Scores par critère' : 'Scores by criterion'}</h4>
                    <div class="criteria-table-details">${Object.values(ev.criteriaDetails).map(cat => `
                        <div class="category-detail-header">${cat[`title_${state.currentLang}`]}</div>
                        ${cat.items.map(item => {
                            const rating = ev.rawCriteria[`crit${critIndex}`]?.rating || 'N/A';
                            const score = (rating !== 'N/A') ? Math.round((rating / 5) * item.points) : 'N/A';
                            critIndex++;
                            return `<div class="criteria-detail-row">
                                <div class="criteria-detail-text">${item[`text_${state.currentLang}`]}</div>
                                <div class="criteria-detail-rating">Note: <strong>${rating}/5</strong></div>
                                <div class="criteria-detail-score">Score: <strong>${score}/${item.points}</strong></div>
                            </div>`;
                        }).join('')}`).join('')}
                    </div>
                    <h4>${state.currentLang === 'fr' ? 'Commentaires' : 'Comments'}</h4>
                    <div class="comments-details">
                        <div class="comment-item"><h6><i class="fas fa-star"></i> ${state.currentLang === 'fr' ? 'Forces' : 'Strengths'}</h6><p>${ev.comments.strengths}</p></div>
                        <div class="comment-item"><h6><i class="fas fa-arrow-up"></i> ${state.currentLang === 'fr' ? 'Améliorations' : 'Improvements'}</h6><p>${ev.comments.toImprove}</p></div>
                        <div class="comment-item"><h6><i class="fas fa-lightbulb"></i> ${state.currentLang === 'fr' ? 'Recommandations' : 'Recommendations'}</h6><p>${ev.comments.recommendations}</p></div>
                    </div>`;
                modal.style.display = 'flex';
            };
            
            window.getPerformanceLevel = (score) => {
                if (score >= 90) return { label_en: "Excellent", label_fr: "Excellent", color: "#27ae60" };
                if (score >= 80) return { label_en: "Very Good", label_fr: "Très Bien", color: "#2ecc71" };
                if (score >= 70) return { label_en: "Good", label_fr: "Bien", color: "#f39c12" };
                if (score >= 60) return { label_en: "Satisfactory", label_fr: "Satisfaisant", color: "#e67e22" };
                return { label_en: "Needs Improvement", label_fr: "À améliorer", color: "#e74c3c" };
            };

            async function generateWordDocument(data) {
                const { Document, Packer, Paragraph, TextRun, HeadingLevel, Table, TableCell, TableRow, WidthType, AlignmentType } = docx;
                let critIndex = 0;
                const tableRows = Object.values(data.criteriaDetails).flatMap(cat => [
                    new TableRow({ children: [new TableCell({ children: [new Paragraph({ text: cat[`title_${state.currentLang}`], bold: true })], columnSpan: 3, shading: { fill: "D3D3D3" } })] }),
                    ...cat.items.map(item => {
                        const rating = data.rawCriteria[`crit${critIndex}`]?.rating || 0;
                        const score = Math.round((rating / 5) * item.points);
                        critIndex++;
                        return new TableRow({ children: [
                            new TableCell({ children: [new Paragraph(item[`text_${state.currentLang}`])] }),
                            new TableCell({ children: [new Paragraph({ text: rating.toString(), alignment: AlignmentType.CENTER })] }),
                            new TableCell({ children: [new Paragraph({ text: `${score}/${item.points}`, alignment: AlignmentType.CENTER })] }),
                        ]});
                    })
                ]);

                const doc = new Document({ sections: [{ children: [
                    new Paragraph({ text: state.currentLang === 'fr' ? "RAPPORT D'ÉVALUATION" : "EVALUATION REPORT", heading: HeadingLevel.HEADING_1, alignment: AlignmentType.CENTER }),
                    new Paragraph({ text: '' }),
                    new Paragraph({ children: [new TextRun({ text: `${state.currentLang==='fr'?'Enseignant':'Teacher'}: `, bold: true }), new TextRun(data.teacherName)] }),
                    new Paragraph({ children: [new TextRun({ text: `${state.currentLang==='fr'?'Évaluateur':'Evaluator'}: `, bold: true }), new TextRun(data.coordinatorName)] }),
                    new Paragraph({ children: [new TextRun({ text: `Date: `, bold: true }), new TextRun(data.visitDate)] }),
                    new Paragraph({ children: [new TextRun({ text: `${state.currentLang==='fr'?'Matière':'Subject'}: `, bold: true }), new TextRun(data.subject)] }),
                    new Paragraph({ text: '' }),
                    new Paragraph({ children: [ new TextRun({ text: `SCORE TOTAL: ${data.grandTotal}/100 (${data.performanceLevel[`label_${state.currentLang}`]})`, bold: true, size: 28 })]}),
                    new Paragraph({ text: '' }),
                    new Paragraph({ text: state.currentLang === 'fr' ? 'TABLEAU DES RÉSULTATS' : 'RESULTS TABLE', heading: HeadingLevel.HEADING_2 }),
                    new Table({ width: { size: 100, type: WidthType.PERCENTAGE }, rows: [
                        new TableRow({ children: [
                            new TableCell({ width: {size:60, type:WidthType.PERCENTAGE}, children: [new Paragraph({text: 'Critère', alignment:AlignmentType.CENTER}) ] }),
                            new TableCell({ width: {size:20, type:WidthType.PERCENTAGE}, children: [new Paragraph({text: 'Note (1-5)', alignment:AlignmentType.CENTER}) ] }),
                            new TableCell({ width: {size:20, type:WidthType.PERCENTAGE}, children: [new Paragraph({text: 'Score', alignment:AlignmentType.CENTER}) ] }),
                        ]}),
                        ...tableRows
                    ]}),
                    new Paragraph({ text: '' }),
                    new Paragraph({ text: state.currentLang === 'fr' ? 'FORCES' : 'STRENGTHS', heading: HeadingLevel.HEADING_2 }), new Paragraph(data.comments.strengths),
                    new Paragraph({ text: '' }),
                    new Paragraph({ text: state.currentLang === 'fr' ? 'AMÉLIORATIONS' : 'IMPROVEMENTS', heading: HeadingLevel.HEADING_2 }), new Paragraph(data.comments.toImprove),
                    new Paragraph({ text: '' }),
                    new Paragraph({ text: state.currentLang === 'fr' ? 'RECOMMANDATIONS' : 'RECOMMENDATIONS', heading: HeadingLevel.HEADING_2 }), new Paragraph(data.comments.recommendations),
                ]}]});

                const blob = await Packer.toBlob(doc);
                saveAs(blob, `Evaluation_${data.teacherName}_${data.visitDate}.docx`);
            }

            function getCriteria() {
                return {
                    preparation: { title_en: "PREPARATION AND PLANNING", title_fr: "PRÉPARATION ET PLANIFICATION", maxPoints: 25, items: [
                        { text_en: "Lesson plans with clear objectives", text_fr: "Plans de cours avec objectifs clairs", points: 5 }, { text_en: "Knowledge of curriculum", text_fr: "Connaissance du curriculum", points: 5 }, { text_en: "Appropriate materials", text_fr: "Matériaux appropriés", points: 5 }, { text_en: "Differentiated instruction", text_fr: "Enseignement différencié", points: 5 }, { text_en: "Assessments aligned with objectives", text_fr: "Évaluations alignées aux objectifs", points: 5 } ]},
                    activities: { title_en: "TEACHING ACTIVITIES", title_fr: "ACTIVITÉS D'ENSEIGNEMENT", maxPoints: 30, items: [
                        { text_en: "Clear and structured lessons", text_fr: "Leçons claires et structurées", points: 6 }, { text_en: "Varied teaching strategies", text_fr: "Stratégies d'enseignement variées", points: 6 }, { text_en: "Appropriate use of technology", text_fr: "Usage approprié de la technologie", points: 6 }, { text_en: "Promotes critical thinking", text_fr: "Favorise la pensée critique", points: 6 }, { text_en: "Timely and constructive feedback", text_fr: "Feedback opportun et constructif", points: 6 } ]},
                    classroomControl: { title_en: "CLASSROOM MANAGEMENT", title_fr: "GESTION DE CLASSE", maxPoints: 20, items: [
                        { text_en: "Conducive learning environment", text_fr: "Environnement d'apprentissage propice", points: 5 }, { text_en: "Effective student behavior management", text_fr: "Gestion efficace du comportement", points: 5 }, { text_en: "Efficient use of time", text_fr: "Utilisation efficace du temps", points: 5 }, { text_en: "Handles disruptions professionally", text_fr: "Gère les perturbations", points: 5 } ]},
                    personalCriteria: { title_en: "PROFESSIONAL QUALITIES", title_fr: "QUALITÉS PROFESSIONNELLES", maxPoints: 25, items: [
                        { text_en: "Professional appearance", text_fr: "Apparence professionnelle", points: 5 }, { text_en: "Punctuality and reliability", text_fr: "Ponctualité et fiabilité", points: 5 }, { text_en: "Effective communication", text_fr: "Communication efficace", points: 5 }, { text_en: "Continuous professional development", text_fr: "Développement professionnel continu", points: 5 }, { text_en: "Dedication to student success", text_fr: "Dévouement au succès des étudiants", points: 5 } ]} };
            }

            window.initSettingsPanel = function() {
                const panel = document.getElementById('settings-panel');
                document.getElementById('settings-btn').addEventListener('click', () => panel.classList.add('active'));
                document.getElementById('close-settings').addEventListener('click', () => panel.classList.remove('active'));
                document.getElementById('save-settings').addEventListener('click', () => {
                    const name = document.getElementById('school-name-input').value.trim();
                    const logo = document.getElementById('logo-url-input').value.trim();
                    if(name) localStorage.setItem('schoolName', name);
                    if(logo) localStorage.setItem('logoUrl', logo);
                    updateSchoolDisplay();
                    panel.classList.remove('active');
                });
            };
            
            function updateSchoolDisplay() {
                const name = localStorage.getItem('schoolName');
                const logo = localStorage.getItem('logoUrl');
                if(name) document.querySelectorAll('[data-lang-en*="System"]').forEach(el => el.dataset.langEn = el.dataset.langEn.replace('System', `- ${name}`));
                if(logo) document.querySelector('.school-logo img').src = logo;
            }
            updateSchoolDisplay();
            setLanguage('fr'); // Default language
        });
    </script>
</body>
</html>
