<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title data-lang-en="Teacher Evaluation System" data-lang-fr="Syst√®me d'√âvaluation des Enseignants">Teacher Evaluation System</title>
    <link rel="stylesheet" href="styles.css">
</head>
<body>

    <div class="container">
        <!-- School Logo -->
        <div class="school-logo">
            <img src="https://lh3.googleusercontent.com/d/1lQ3Babrs3Wgv4rakVmkK0oCWcM0cTKPK" alt="School Logo" />
        </div>

        <!-- Language Switcher -->
        <div class="language-switcher">
            <button id="lang-en">English</button>
            <button id="lang-fr">Fran√ßais</button>
        </div>

        <!-- Login Page -->
        <div id="login-page" class="page active">
            <div class="card">
                <h1 data-lang-en="Login" data-lang-fr="Connexion">Login</h1>
                <form id="login-form">
                    <input type="text" id="username" placeholder-en="Username" placeholder-fr="Nom d'utilisateur" required>
                    <div class="password-container">
                        <input type="password" id="password" placeholder-en="Password" placeholder-fr="Mot de passe" required>
                        <button type="button" id="toggle-password" class="password-toggle" aria-label="Show password">
                            <span id="password-icon">üëÅÔ∏è</span>
                        </button>
                    </div>
                    <div class="checkbox-container">
                        <input type="checkbox" id="remember-me">
                        <label for="remember-me" data-lang-en="Remember me" data-lang-fr="Rester connect√©">Remember me</label>
                    </div>
                    <button type="submit" data-lang-en="Login" data-lang-fr="Se connecter">Login</button>
                </form>
                <p id="login-error" class="error-message"></p>
                <div class="test-credentials">
                    <h4 data-lang-en="Test Accounts" data-lang-fr="Comptes de Test">Test Accounts</h4>
                    <p><strong data-lang-en="Coordinators" data-lang-fr="Coordinateurs">Coordinators:</strong><br>
                    Mohamed / Mohamed@86<br>
                    Zohra / Zohra@40<br>
                    Rasha / Rasha@26</p>
                    <p><strong data-lang-en="Teachers" data-lang-fr="Enseignants">Teachers:</strong><br>
                    Morched / Morched<br>
                    Kamel / Kamel<br>
                    <em data-lang-en="(Any teacher name as username/password)" data-lang-fr="(Nom d'enseignant comme identifiant/mot de passe)">(Any teacher name as username/password)</em></p>
                </div>
            </div>
        </div>

        <!-- Coordinator Dashboard -->
        <div id="coordinator-dashboard" class="page">
            <h1 data-lang-en="Coordinator Dashboard" data-lang-fr="Tableau de Bord Coordinateur">Coordinator Dashboard</h1>
            <h2 id="coordinator-welcome"></h2>
            <h3 data-lang-en="Select a teacher to evaluate:" data-lang-fr="S√©lectionnez un enseignant √† √©valuer :">Select a teacher to evaluate:</h3>
            <select id="teacher-select"></select>
            <div id="evaluation-form-container"></div>
            <button id="logout-btn" data-lang-en="Logout" data-lang-fr="D√©connexion">Logout</button>
        </div>

        <!-- Teacher Dashboard -->
        <div id="teacher-dashboard" class="page">
            <h1 data-lang-en="Teacher Dashboard" data-lang-fr="Tableau de Bord Enseignant">Teacher Dashboard</h1>
            <h2 id="teacher-welcome"></h2>
            <div id="evaluation-reports"></div>
            <button id="logout-btn-teacher" data-lang-en="Logout" data-lang-fr="D√©connexion">Logout</button>
        </div>

    </div>

    <script>
        // --- Client-Side Logic ---
        document.addEventListener('DOMContentLoaded', () => {
            const state = {
                currentUser: null,
                currentLang: 'en'
            };

            const pages = {
                login: document.getElementById('login-page'),
                coordinator: document.getElementById('coordinator-dashboard'),
                teacher: document.getElementById('teacher-dashboard')
            };

            // --- Language Switcher ---
            const langElements = document.querySelectorAll('[data-lang-en], [data-lang-fr]');
            const placeholderElements = document.querySelectorAll('[placeholder-en], [placeholder-fr]');

            function setLanguage(lang) {
                state.currentLang = lang;
                langElements.forEach(el => {
                    el.textContent = el.dataset[`lang-${lang}`];
                    if(el.tagName === 'TITLE') document.title = el.dataset[`lang-${lang}`];
                });
                placeholderElements.forEach(el => {
                    el.placeholder = el.getAttribute(`placeholder-${lang}`);
                });
            }

            document.getElementById('lang-en').addEventListener('click', () => setLanguage('en'));
            document.getElementById('lang-fr').addEventListener('click', () => setLanguage('fr'));

            // --- Password Toggle Functionality ---
            document.getElementById('toggle-password').addEventListener('click', function() {
                const passwordInput = document.getElementById('password');
                const passwordIcon = document.getElementById('password-icon');
                
                if (passwordInput.type === 'password') {
                    passwordInput.type = 'text';
                    passwordIcon.textContent = 'üôà';
                } else {
                    passwordInput.type = 'password';
                    passwordIcon.textContent = 'üëÅÔ∏è';
                }
            });

            // --- Remember Me Functionality ---
            // Charger les donn√©es sauvegard√©es au d√©marrage
            function loadSavedCredentials() {
                const savedCredentials = localStorage.getItem('teacherEvaluationCredentials');
                if (savedCredentials) {
                    const { username, password, rememberMe } = JSON.parse(savedCredentials);
                    if (rememberMe) {
                        document.getElementById('username').value = username;
                        document.getElementById('password').value = password;
                        document.getElementById('remember-me').checked = true;
                    }
                }
            }

            // Sauvegarder les donn√©es si "Rester connect√©" est coch√©
            function saveCredentials(username, password, rememberMe) {
                if (rememberMe) {
                    const credentials = { username, password, rememberMe: true };
                    localStorage.setItem('teacherEvaluationCredentials', JSON.stringify(credentials));
                } else {
                    localStorage.removeItem('teacherEvaluationCredentials');
                }
            }

            // Charger les donn√©es sauvegard√©es au d√©marrage
            loadSavedCredentials();

            // --- Navigation ---
            function showPage(pageName) {
                Object.values(pages).forEach(page => page.classList.remove('active'));
                pages[pageName].classList.add('active');
            }

            // --- Base de donn√©es utilisateurs c√¥t√© client (solution temporaire fonctionnelle) ---
            const USERS_DATABASE = [
                // Coordinateurs
                { username: 'Mohamed', password: 'Medch!!!', role: 'coordinator', assignedTeachers: ['Morched', 'Kamel', 'Abas', 'Zine', 'Youssef', 'Oumarou', 'Tonga', 'Sylvano', 'Sami', 'Mohamed Ali'] },
                { username: 'Zohra', password: 'Zohra**!!', role: 'coordinator', assignedTeachers: ['Aichetou', 'Inas', 'Anwar', 'Souha', 'Amal', 'Shanouja', 'Jana', 'Hiba'] },
                { username: 'Racha', password: 'Racha@@!!', role: 'coordinator', assignedTeachers: ['Amal', 'Rouba', 'Rayan', 'Imane', 'Nesrine', 'Fatima', 'Samar', 'Romana', 'Nour'] },
                // Enseignants
                ...['Morched', 'Kamel', 'Abas', 'Zine', 'Youssef', 'Oumarou', 'Tonga', 'Sylvano', 'Sami', 'Mohamed Ali', 'Aichetou', 'Inas', 'Anwar', 'Souha', 'Amal', 'Shanouja', 'Jana', 'Hiba', 'Rouba', 'Rayan', 'Imane', 'Nesrine', 'Fatima', 'Samar', 'Romana', 'Nour'].map(name => ({ username: name, password: name, role: 'teacher' }))
            ];

            // Base de donn√©es √©valuations c√¥t√© client
            let EVALUATIONS_DATABASE = [];

            // --- Login Logic (c√¥t√© client - fonctionne imm√©diatement) ---
            document.getElementById('login-form').addEventListener('submit', (e) => {
                e.preventDefault();
                const username = document.getElementById('username').value;
                const password = document.getElementById('password').value;
                const rememberMe = document.getElementById('remember-me').checked;
                
                console.log(`Tentative de connexion: ${username} / ${password}`);
                
                // Recherche dans la base de donn√©es locale
                const user = USERS_DATABASE.find(u => u.username === username && u.password === password);
                
                if (user) {
                    console.log(`Connexion r√©ussie pour: ${username} (${user.role})`);
                    
                    // Sauvegarder les identifiants si demand√©
                    saveCredentials(username, password, rememberMe);
                    
                    state.currentUser = user;
                    if (user.role === 'coordinator') {
                        renderCoordinatorDashboard();
                        showPage('coordinator');
                    } else {
                        renderTeacherDashboard();
                        showPage('teacher');
                    }
                    
                    // Effacer les messages d'erreur
                    document.getElementById('login-error').textContent = '';
                } else {
                    console.log(`√âchec de connexion pour: ${username}`);
                    document.getElementById('login-error').textContent = state.currentLang === 'fr' ? 'Identifiants invalides' : 'Invalid credentials';
                }
            });
            
            // --- Logout ---
            function logout() {
                state.currentUser = null;
                document.getElementById('login-form').reset();
                document.getElementById('login-error').textContent = '';
                
                // Ne pas effacer les identifiants si "Rester connect√©" est coch√©
                const rememberMe = document.getElementById('remember-me').checked;
                if (!rememberMe) {
                    localStorage.removeItem('teacherEvaluationCredentials');
                } else {
                    // Recharger les identifiants sauvegard√©s
                    loadSavedCredentials();
                }
                
                showPage('login');
            }
            document.getElementById('logout-btn').addEventListener('click', logout);
            document.getElementById('logout-btn-teacher').addEventListener('click', logout);


            // --- Coordinator Logic ---
            function renderCoordinatorDashboard() {
                document.getElementById('coordinator-welcome').textContent = `${state.currentLang === 'fr' ? 'Bienvenue' : 'Welcome'}, ${state.currentUser.username}`;
                const teacherSelect = document.getElementById('teacher-select');
                teacherSelect.innerHTML = `<option value="">${state.currentLang === 'fr' ? 'Choisir...' : 'Choose...'}</option>`;
                state.currentUser.assignedTeachers.forEach(teacher => {
                    const option = document.createElement('option');
                    option.value = teacher;
                    option.textContent = teacher;
                    teacherSelect.appendChild(option);
                });
            }

            document.getElementById('teacher-select').addEventListener('change', (e) => {
                const teacherName = e.target.value;
                if (teacherName) {
                    renderEvaluationForm(teacherName);
                } else {
                    document.getElementById('evaluation-form-container').innerHTML = '';
                }
            });

            // --- Evaluation Form ---
            function renderEvaluationForm(teacherName) {
                const criteria = {
                    preparation: {
                        title_en: "PREPARATION AND PLANNING",
                        title_fr: "PR√âPARATION ET PLANIFICATION",
                        maxPoints: 25,
                        items: [
                            { text_en: "Prepares comprehensive lesson plans with clear learning objectives", text_fr: "Pr√©pare des plans de cours complets avec des objectifs d'apprentissage clairs", points: 5 },
                            { text_en: "Demonstrates thorough knowledge of curriculum and standards", text_fr: "D√©montre une connaissance approfondie du curriculum et des standards", points: 5 },
                            { text_en: "Selects appropriate materials and resources for lessons", text_fr: "S√©lectionne des mat√©riaux et ressources appropri√©s pour les le√ßons", points: 5 },
                            { text_en: "Plans differentiated instruction to meet diverse student needs", text_fr: "Planifie un enseignement diff√©renci√© pour r√©pondre aux besoins diversifi√©s des √©tudiants", points: 5 },
                            { text_en: "Designs assessments aligned with learning objectives", text_fr: "Con√ßoit des √©valuations align√©es avec les objectifs d'apprentissage", points: 5 }
                        ]
                    },
                    activities: {
                        title_en: "TEACHING ACTIVITIES AND METHODS",
                        title_fr: "ACTIVIT√âS ET M√âTHODES D'ENSEIGNEMENT",
                        maxPoints: 30,
                        items: [
                            { text_en: "Delivers clear and well-structured lessons", text_fr: "Dispense des le√ßons claires et bien structur√©es", points: 6 },
                            { text_en: "Uses varied teaching strategies and methodologies effectively", text_fr: "Utilise efficacement des strat√©gies et m√©thodologies d'enseignement vari√©es", points: 6 },
                            { text_en: "Incorporates technology and multimedia resources appropriately", text_fr: "Int√®gre de mani√®re appropri√©e la technologie et les ressources multim√©dias", points: 6 },
                            { text_en: "Promotes critical thinking and problem-solving skills", text_fr: "Favorise la pens√©e critique et les comp√©tences de r√©solution de probl√®mes", points: 6 },
                            { text_en: "Provides timely and constructive feedback to students", text_fr: "Fournit aux √©tudiants des commentaires opportuns et constructifs", points: 6 }
                        ]
                    },
                    classroomControl: {
                        title_en: "CLASSROOM MANAGEMENT AND CONTROL",
                        title_fr: "GESTION ET CONTR√îLE DE LA CLASSE",
                        maxPoints: 20,
                        items: [
                            { text_en: "Maintains an organized and conducive learning environment", text_fr: "Maintient un environnement d'apprentissage organis√© et propice", points: 5 },
                            { text_en: "Manages student behavior effectively and fairly", text_fr: "G√®re le comportement des √©tudiants de mani√®re efficace et √©quitable", points: 5 },
                            { text_en: "Uses time efficiently and maintains lesson pace", text_fr: "Utilise le temps efficacement et maintient le rythme de la le√ßon", points: 5 },
                            { text_en: "Handles disruptions professionally and minimally", text_fr: "G√®re les perturbations de mani√®re professionnelle et minimale", points: 5 }
                        ]
                    },
                    personalCriteria: {
                        title_en: "PERSONAL AND PROFESSIONAL QUALITIES",
                        title_fr: "QUALIT√âS PERSONNELLES ET PROFESSIONNELLES",
                        maxPoints: 25,
                        items: [
                            { text_en: "Demonstrates professional appearance and punctuality", text_fr: "D√©montre une apparence professionnelle et une ponctualit√©", points: 5 },
                            { text_en: "Shows enthusiasm and passion for teaching", text_fr: "Montre de l'enthousiasme et une passion pour l'enseignement", points: 5 },
                            { text_en: "Communicates effectively with students using appropriate language", text_fr: "Communique efficacement avec les √©tudiants en utilisant un langage appropri√©", points: 5 },
                            { text_en: "Builds positive relationships with students", text_fr: "√âtablit des relations positives avec les √©tudiants", points: 5 },
                            { text_en: "Reflects on practice and seeks continuous improvement", text_fr: "R√©fl√©chit sur la pratique et cherche une am√©lioration continue", points: 5 }
                        ]
                    }
                };

                let formHTML = `<form id="eval-form" class="card">
                    <h3>${state.currentLang === 'fr' ? '√âvaluation pour' : 'Evaluation for'} ${teacherName}</h3>
                    
                    <!-- Class and Semester Fields -->
                    <div class="basic-info-section">
                        <div class="form-row">
                            <div class="form-group">
                                <label for="class-field">${state.currentLang === 'fr' ? 'Classe :' : 'Class:'}</label>
                                <input type="text" id="class-field" name="class" required placeholder="${state.currentLang === 'fr' ? 'Ex: 6√®me A' : 'Ex: Grade 6A'}">
                            </div>
                            <div class="form-group">
                                <label for="semester-field">${state.currentLang === 'fr' ? 'Semestre :' : 'Semester:'}</label>
                                <select id="semester-field" name="semester" required>
                                    <option value="">${state.currentLang === 'fr' ? 'S√©lectionner...' : 'Select...'}</option>
                                    <option value="1">${state.currentLang === 'fr' ? '1er Semestre' : '1st Semester'}</option>
                                    <option value="2">${state.currentLang === 'fr' ? '2√®me Semestre' : '2nd Semester'}</option>
                                </select>
                            </div>
                        </div>
                    </div>
                `;
                let criteriaIndex = 0;
                
                for(const category in criteria){
                    const cat = criteria[category];
                    formHTML += `<fieldset>
                        <legend>${cat[`title_${state.currentLang}`]} (${state.currentLang === 'fr' ? 'Maximum' : 'Max'}: ${cat.maxPoints} ${state.currentLang === 'fr' ? 'points' : 'points'})</legend>`;
                    
                    cat.items.forEach((item, index) => {
                        formHTML += `<div class="criteria-row">
                            <p>${item[`text_${state.currentLang}`]} <span class="points-info">(${item.points} ${state.currentLang === 'fr' ? 'pts max' : 'pts max'})</span></p>
                            <div class="rating">`;
                        
                        // Cr√©er des options de notation bas√©es sur les points maximum de l'item
                        for(let i = 0; i <= item.points; i++) {
                            formHTML += `
                                <input type="radio" id="crit${criteriaIndex}-${i}" name="crit${criteriaIndex}" value="${i}" ${i === 0 ? '' : ''} required>
                                <label for="crit${criteriaIndex}-${i}">${i}</label>
                            `;
                        }
                        
                        formHTML += `</div></div>`;
                        criteriaIndex++;
                    });
                    formHTML += `</fieldset>`;
                }
                
                formHTML += `
                    <div class="comments-section">
                        <div>
                            <label for="comments-strengths">${state.currentLang === 'fr' ? 'Points forts observ√©s :' : 'Observed Strengths:'}</label>
                            <textarea id="comments-strengths" placeholder="${state.currentLang === 'fr' ? 'D√©crivez les aspects positifs de la performance...' : 'Describe positive aspects of performance...'}" required></textarea>
                        </div>
                        <div>
                            <label for="comments-improve">${state.currentLang === 'fr' ? 'Domaines √† am√©liorer :' : 'Areas for Improvement:'}</label>
                            <textarea id="comments-improve" placeholder="${state.currentLang === 'fr' ? 'Identifiez les aspects n√©cessitant une am√©lioration...' : 'Identify aspects needing improvement...'}" required></textarea>
                        </div>
                        <div>
                            <label for="comments-recommendations">${state.currentLang === 'fr' ? 'Recommandations sp√©cifiques :' : 'Specific Recommendations:'}</label>
                            <textarea id="comments-recommendations" placeholder="${state.currentLang === 'fr' ? 'Actions concr√®tes recommand√©es...' : 'Concrete recommended actions...'}" required></textarea>
                        </div>
                    </div>
                    
                    <div class="score-summary">
                        <div class="total-score">
                            <span class="score-label">${state.currentLang === 'fr' ? 'Score Total :' : 'Total Score:'}</span>
                            <span id="grand-total-display" class="score-value">0</span>
                            <span class="score-max">/ 100</span>
                        </div>
                        <div class="performance-level">
                            <span class="level-label">${state.currentLang === 'fr' ? 'Niveau :' : 'Performance Level:'}</span>
                            <span id="performance-level" class="level-value">${state.currentLang === 'fr' ? '√Ä calculer' : 'To be calculated'}</span>
                        </div>
                    </div>
                    
                    <div class="form-buttons">
                        <button type="submit" class="submit-btn">
                            <i class="btn-icon">üíæ</i>
                            ${state.currentLang === 'fr' ? 'Enregistrer l\'√âvaluation' : 'Save Evaluation'}
                        </button>
                        <button type="button" id="generate-word" class="word-btn">
                            <i class="btn-icon">üìÑ</i>
                            ${state.currentLang === 'fr' ? 'G√©n√©rer Rapport Word' : 'Generate Word Report'}
                        </button>
                    </div>
                </form>`;

                const container = document.getElementById('evaluation-form-container');
                container.innerHTML = formHTML;

                // Automatic Total Calculation and Performance Level Update
                container.querySelector('#eval-form').addEventListener('change', () => {
                    const ratings = container.querySelectorAll('input[type="radio"]:checked');
                    let total = 0;
                    ratings.forEach(r => total += parseInt(r.value, 10));
                    document.getElementById('grand-total-display').textContent = total;
                    
                    // Update performance level
                    const performanceLevel = getPerformanceLevel(total);
                    const levelElement = document.getElementById('performance-level');
                    levelElement.textContent = state.currentLang === 'fr' ? performanceLevel.label_fr : performanceLevel.label_en;
                    levelElement.className = `level-value ${performanceLevel.class}`;
                });
                
                // Form Submission
                container.querySelector('#eval-form').addEventListener('submit', async (e) => {
                    e.preventDefault();
                    const formData = new FormData(e.target);
                    const criteriaData = {};
                    let grandTotal = 0;
                    
                    // Separate criteria data from other form data
                    for(let [key, value] of formData.entries()){
                        if (key.startsWith('crit')) {
                            criteriaData[key] = parseInt(value, 10);
                            grandTotal += parseInt(value, 10);
                        }
                    }
                    
                    const payload = {
                        teacherName,
                        coordinatorName: state.currentUser.username,
                        class: formData.get('class'),
                        semester: formData.get('semester'),
                        criteria: criteriaData,
                        criteriaDetails: criteria, // Ajouter les d√©tails des crit√®res pour affichage ult√©rieur
                        comments: {
                            strengths: document.getElementById('comments-strengths').value,
                            toImprove: document.getElementById('comments-improve').value,
                            recommendations: document.getElementById('comments-recommendations').value
                        },
                        grandTotal
                    };

                    // Sauvegarder l'√©valuation dans la base locale
                    const evaluation = {
                        id: Date.now().toString(),
                        ...payload,
                        date: new Date()
                    };
                    
                    EVALUATIONS_DATABASE.push(evaluation);
                    console.log('√âvaluation sauvegard√©e:', evaluation);
                    
                    alert(state.currentLang === 'fr' ? '√âvaluation soumise avec succ√®s !' : 'Evaluation submitted successfully!');
                    container.innerHTML = '';
                    
                    // R√©initialiser la s√©lection d'enseignant
                    document.getElementById('teacher-select').value = '';
                });
                
                // G√©n√©ration Word
                container.querySelector('#generate-word').addEventListener('click', () => {
                    generateWordReport(teacherName, criteria);
                });
            }

            // --- Word Generation Function ---
            async function generateWordReport(teacherName, criteria) {
                try {
                    const visitDate = document.getElementById('visit-date')?.value || new Date().toISOString().split('T')[0];
                    const visitTime = document.getElementById('visit-time')?.value || '';
                    const lessonSubject = document.getElementById('lesson-subject')?.value || '';
                    const className = document.getElementById('class-field')?.value || '';
                    const semester = document.getElementById('semester-field')?.value || '';
                    
                    const { Document, Paragraph, TextRun, HeadingLevel, AlignmentType, Table, TableRow, TableCell, WidthType } = docx;
                    
                    // Collect current form data
                    const formData = new FormData(document.getElementById('eval-form'));
                    const criteriaData = {};
                    let grandTotal = 0;
                    
                    for(let [key, value] of formData.entries()){
                        if (key.startsWith('crit')) {
                            criteriaData[key] = parseInt(value, 10);
                            grandTotal += parseInt(value, 10);
                        }
                    }
                    
                    const comments = {
                        strengths: document.getElementById('comments-strengths')?.value || '',
                        toImprove: document.getElementById('comments-improve')?.value || '',
                        recommendations: document.getElementById('comments-recommendations')?.value || ''
                    };
                    
                    // Create detailed criteria breakdown
                    const criteriaBreakdown = [];
                    let criteriaIndex = 0;
                    
                    for(const category in criteria) {
                        const cat = criteria[category];
                        criteriaBreakdown.push({
                            categoryTitle: cat[`title_${state.currentLang}`],
                            maxPoints: cat.maxPoints,
                            items: cat.items.map((item, index) => ({
                                text: item[`text_${state.currentLang}`],
                                maxPoints: item.points,
                                score: criteriaData[`crit${criteriaIndex + index}`] || 0
                            }))
                        });
                        criteriaIndex += cat.items.length;
                    }
                    
                    // Performance level
                    const performanceLevel = getPerformanceLevel(grandTotal);
                    
                    const doc = new Document({
                        sections: [{
                            children: [
                                // Header
                                new Paragraph({
                                    children: [new TextRun({ text: state.currentLang === 'fr' ? 'RAPPORT D\'√âVALUATION ACAD√âMIQUE' : 'ACADEMIC EVALUATION REPORT', bold: true, size: 28 })],
                                    alignment: AlignmentType.CENTER,
                                    spacing: { after: 400 }
                                }),
                                
                                // Basic Information Table
                                new Table({
                                    width: { size: 100, type: WidthType.PERCENTAGE },
                                    rows: [
                                        new TableRow({
                                            children: [
                                                new TableCell({ children: [new Paragraph({ children: [new TextRun({ text: state.currentLang === 'fr' ? 'Enseignant:' : 'Teacher:', bold: true })] })] }),
                                                new TableCell({ children: [new Paragraph({ children: [new TextRun({ text: teacherName })] })] })
                                            ]
                                        }),
                                        new TableRow({
                                            children: [
                                                new TableCell({ children: [new Paragraph({ children: [new TextRun({ text: state.currentLang === 'fr' ? '√âvaluateur:' : 'Evaluator:', bold: true })] })] }),
                                                new TableCell({ children: [new Paragraph({ children: [new TextRun({ text: state.currentUser.username })] })] })
                                            ]
                                        }),
                                        new TableRow({
                                            children: [
                                                new TableCell({ children: [new Paragraph({ children: [new TextRun({ text: state.currentLang === 'fr' ? 'Date:' : 'Date:', bold: true })] })] }),
                                                new TableCell({ children: [new Paragraph({ children: [new TextRun({ text: visitDate })] })] })
                                            ]
                                        }),
                                        ...(className ? [new TableRow({
                                            children: [
                                                new TableCell({ children: [new Paragraph({ children: [new TextRun({ text: state.currentLang === 'fr' ? 'Classe:' : 'Class:', bold: true })] })] }),
                                                new TableCell({ children: [new Paragraph({ children: [new TextRun({ text: className })] })] })
                                            ]
                                        })] : []),
                                        ...(semester ? [new TableRow({
                                            children: [
                                                new TableCell({ children: [new Paragraph({ children: [new TextRun({ text: state.currentLang === 'fr' ? 'Semestre:' : 'Semester:', bold: true })] })] }),
                                                new TableCell({ children: [new Paragraph({ children: [new TextRun({ text: semester === '1' ? (state.currentLang === 'fr' ? '1er Semestre' : '1st Semester') : (state.currentLang === 'fr' ? '2√®me Semestre' : '2nd Semester') })] })] })
                                            ]
                                        })] : [])
                                    ]
                                }),
                                
                                new Paragraph({ text: "", spacing: { after: 200 } }),
                                
                                // Score Summary
                                new Paragraph({
                                    children: [
                                        new TextRun({ text: `${state.currentLang === 'fr' ? 'Score Total: ' : 'Total Score: '}${grandTotal}/100`, bold: true, size: 24 }),
                                        new TextRun({ text: ` - ${state.currentLang === 'fr' ? performanceLevel.label_fr : performanceLevel.label_en}`, bold: true, size: 24 })
                                    ],
                                    alignment: AlignmentType.CENTER,
                                    spacing: { after: 400 }
                                }),
                                
                                // Detailed Criteria Breakdown
                                new Paragraph({
                                    children: [new TextRun({ text: state.currentLang === 'fr' ? 'D√âTAIL DES CRIT√àRES D\'√âVALUATION' : 'DETAILED EVALUATION CRITERIA', bold: true, size: 20 })],
                                    spacing: { after: 200 }
                                }),
                                
                                // Criteria Tables
                                ...criteriaBreakdown.flatMap(category => [
                                    new Paragraph({
                                        children: [new TextRun({ text: `${category.categoryTitle} (${category.maxPoints} pts max)`, bold: true, size: 16 })],
                                        spacing: { before: 200, after: 100 }
                                    }),
                                    new Table({
                                        width: { size: 100, type: WidthType.PERCENTAGE },
                                        rows: [
                                            new TableRow({
                                                children: [
                                                    new TableCell({ 
                                                        children: [new Paragraph({ children: [new TextRun({ text: state.currentLang === 'fr' ? 'Crit√®re' : 'Criteria', bold: true })] })] 
                                                    }),
                                                    new TableCell({ 
                                                        children: [new Paragraph({ children: [new TextRun({ text: state.currentLang === 'fr' ? 'Points Max' : 'Max Points', bold: true })] })] 
                                                    }),
                                                    new TableCell({ 
                                                        children: [new Paragraph({ children: [new TextRun({ text: state.currentLang === 'fr' ? 'Score Obtenu' : 'Score Obtained', bold: true })] })] 
                                                    })
                                                ]
                                            }),
                                            ...category.items.map(item => new TableRow({
                                                children: [
                                                    new TableCell({ children: [new Paragraph({ children: [new TextRun({ text: item.text })] })] }),
                                                    new TableCell({ children: [new Paragraph({ children: [new TextRun({ text: item.maxPoints.toString() })] })] }),
                                                    new TableCell({ children: [new Paragraph({ children: [new TextRun({ text: item.score.toString() })] })] })
                                                ]
                                            }))
                                        ]
                                    })
                                ]),
                                
                                new Paragraph({ text: "", spacing: { after: 400 } }),
                                
                                // Comments Section
                                new Paragraph({
                                    children: [new TextRun({ text: state.currentLang === 'fr' ? 'COMMENTAIRES D√âTAILL√âS' : 'DETAILED COMMENTS', bold: true, size: 20 })],
                                    spacing: { after: 200 }
                                }),
                                
                                new Paragraph({
                                    children: [new TextRun({ text: state.currentLang === 'fr' ? 'Points forts observ√©s:' : 'Observed Strengths:', bold: true })],
                                    spacing: { before: 100 }
                                }),
                                new Paragraph({ children: [new TextRun({ text: comments.strengths })] }),
                                
                                new Paragraph({
                                    children: [new TextRun({ text: state.currentLang === 'fr' ? 'Domaines √† am√©liorer:' : 'Areas for Improvement:', bold: true })],
                                    spacing: { before: 200 }
                                }),
                                new Paragraph({ children: [new TextRun({ text: comments.toImprove })] }),
                                
                                new Paragraph({
                                    children: [new TextRun({ text: state.currentLang === 'fr' ? 'Recommandations sp√©cifiques:' : 'Specific Recommendations:', bold: true })],
                                    spacing: { before: 200 }
                                }),
                                new Paragraph({ children: [new TextRun({ text: comments.recommendations })] })
                            ]
                        }]
                    });
                    
                    const blob = await docx.Packer.toBlob(doc);
                    const fileName = `Evaluation_${teacherName}_${visitDate}.docx`;
                    saveAs(blob, fileName);
                    
                    alert(state.currentLang === 'fr' ? 'Rapport Word g√©n√©r√© avec succ√®s !' : 'Word report generated successfully!');
                } catch (error) {
                    console.error('Error generating Word document:', error);
                    alert(state.currentLang === 'fr' ? 'Erreur lors de la g√©n√©ration du document Word' : 'Error generating Word document');
                }
            }

            // --- Teacher Logic ---
            function renderTeacherDashboard() {
                document.getElementById('teacher-welcome').textContent = `${state.currentLang === 'fr' ? 'Bienvenue' : 'Welcome'}, ${state.currentUser.username}`;
                const reportsContainer = document.getElementById('evaluation-reports');
                
                // Filtrer les √©valuations pour cet enseignant dans la base locale
                const evaluations = EVALUATIONS_DATABASE.filter(eval => eval.teacherName === state.currentUser.username);
                console.log(`Trouv√© ${evaluations.length} √©valuations pour ${state.currentUser.username}`);
                
                if (evaluations.length === 0) {
                    reportsContainer.innerHTML = `
                        <div class="card no-evaluations">
                            <h3>${state.currentLang === 'fr' ? 'Aucune √©valuation disponible' : 'No evaluations available'}</h3>
                            <p>${state.currentLang === 'fr' ? 'Vos √©valuations appara√Ætront ici une fois qu\'elles seront effectu√©es par les coordinateurs.' : 'Your evaluations will appear here once they are conducted by coordinators.'}</p>
                        </div>
                    `;
                    return;
                }
                
                // Sort evaluations by date (most recent first)
                evaluations.sort((a, b) => new Date(b.date) - new Date(a.date));
                
                // Calculate statistics
                const latestScore = evaluations[0].grandTotal;
                const averageScore = evaluations.reduce((sum, eval) => sum + eval.grandTotal, 0) / evaluations.length;
                const firstScore = evaluations[evaluations.length - 1].grandTotal;
                const progression = evaluations.length > 1 ? latestScore - firstScore : 0;
                
                let reportsHTML = `
                    <!-- Statistiques de progression -->
                    <div class="card statistics-card">
                        <h3>${state.currentLang === 'fr' ? 'Statistiques de Performance' : 'Performance Statistics'}</h3>
                        <div class="stats-grid">
                            <div class="stat-item">
                                <span class="stat-label">${state.currentLang === 'fr' ? 'Nombre d\'√©valuations' : 'Total Evaluations'}</span>
                                <span class="stat-value">${evaluations.length}</span>
                            </div>
                            <div class="stat-item">
                                <span class="stat-label">${state.currentLang === 'fr' ? 'Score moyen' : 'Average Score'}</span>
                                <span class="stat-value">${averageScore.toFixed(1)}/100</span>
                            </div>
                            <div class="stat-item">
                                <span class="stat-label">${state.currentLang === 'fr' ? 'Derni√®re √©valuation' : 'Latest Score'}</span>
                                <span class="stat-value">${latestScore}/100</span>
                            </div>
                            <div class="stat-item">
                                <span class="stat-label">${state.currentLang === 'fr' ? 'Progression' : 'Progress'}</span>
                                <span class="stat-value ${progression >= 0 ? 'positive' : 'negative'}">
                                    ${progression >= 0 ? '+' : ''}${progression} ${state.currentLang === 'fr' ? 'points' : 'points'}
                                </span>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Historique des √©valuations -->
                    <div class="card">
                        <h3>${state.currentLang === 'fr' ? 'Historique des √âvaluations' : 'Evaluation History'}</h3>
                        <div class="evaluations-timeline">`;
                
                evaluations.forEach((eval, index) => {
                    const evalDate = new Date(eval.date);
                    const isLatest = index === 0;
                    
                    reportsHTML += `
                        <div class="timeline-item ${isLatest ? 'latest' : ''}">
                            <div class="timeline-marker"></div>
                            <div class="timeline-content">
                                <div class="eval-header">
                                    <h4>${state.currentLang === 'fr' ? '√âvaluation du' : 'Evaluation from'} ${evalDate.toLocaleDateString(state.currentLang === 'fr' ? 'fr-FR' : 'en-US')}</h4>
                                    <span class="eval-score">${eval.grandTotal}/100</span>
                                    <span class="eval-level ${eval.performanceLevel ? eval.performanceLevel.toLowerCase().replace(' ', '-') : ''}">${eval.performanceLevel || getPerformanceLevel(eval.grandTotal)}</span>
                                </div>
                                <div class="eval-details">
                                    <p><strong>${state.currentLang === 'fr' ? '√âvaluateur :' : 'Evaluator:'}</strong> ${eval.coordinatorName}</p>
                                    ${eval.visitDate ? `<p><strong>${state.currentLang === 'fr' ? 'Date de visite :' : 'Visit Date:'}</strong> ${eval.visitDate}</p>` : ''}
                                    ${eval.lessonSubject ? `<p><strong>${state.currentLang === 'fr' ? 'Mati√®re :' : 'Subject:'}</strong> ${eval.lessonSubject}</p>` : ''}
                                    ${eval.class ? `<p><strong>${state.currentLang === 'fr' ? 'Classe :' : 'Class:'}</strong> ${eval.class}</p>` : ''}
                                    ${eval.semester ? `<p><strong>${state.currentLang === 'fr' ? 'Semestre :' : 'Semester:'}</strong> ${eval.semester === '1' ? (state.currentLang === 'fr' ? '1er Semestre' : '1st Semester') : (state.currentLang === 'fr' ? '2√®me Semestre' : '2nd Semester')}</p>` : ''}
                                </div>
                                
                                <div class="eval-comments">
                                    ${eval.comments.strengths ? `
                                    <div class="comment-section">
                                        <h5>${state.currentLang === 'fr' ? 'Points forts' : 'Strengths'}</h5>
                                        <p>${eval.comments.strengths}</p>
                                    </div>` : ''}
                                    
                                    ${eval.comments.toImprove ? `
                                    <div class="comment-section">
                                        <h5>${state.currentLang === 'fr' ? '√Ä am√©liorer' : 'To Improve'}</h5>
                                        <p>${eval.comments.toImprove}</p>
                                    </div>` : ''}
                                    
                                    ${eval.comments.recommendations ? `
                                    <div class="comment-section">
                                        <h5>${state.currentLang === 'fr' ? 'Recommandations' : 'Recommendations'}</h5>
                                        <p>${eval.comments.recommendations}</p>
                                    </div>` : ''}
                                </div>
                                
                                <!-- Detailed Criteria Breakdown -->
                                <div class="criteria-breakdown">
                                    <button class="toggle-details" onclick="toggleCriteriaDetails('${eval.id}')">
                                        <i id="toggle-icon-${eval.id}">‚ñº</i>
                                        ${state.currentLang === 'fr' ? 'Voir d√©tails des crit√®res' : 'View criteria details'}
                                    </button>
                                    <div id="criteria-details-${eval.id}" class="criteria-details" style="display: none;">
                                        ${eval.criteriaDetails ? renderCriteriaDetails(eval) : ''}
                                    </div>
                                </div>
                                
                                <div class="eval-actions">
                                    <button onclick="generateWordReport('${eval.id}')" class="btn-download">
                                        <i>üìÑ</i> ${state.currentLang === 'fr' ? 'T√©l√©charger Rapport' : 'Download Report'}
                                    </button>
                                </div>
                            </div>
                        </div>
                    `;
                });
                
                reportsHTML += `
                        </div>
                    </div>
                `;
                
                reportsContainer.innerHTML = reportsHTML;
            }
            
            function renderCriteriaDetails(evaluation) {
                if (!evaluation.criteriaDetails) return '';
                
                let detailsHTML = '<div class="criteria-table">';
                let criteriaIndex = 0;
                
                for (const category in evaluation.criteriaDetails) {
                    const cat = evaluation.criteriaDetails[category];
                    detailsHTML += `
                        <div class="criteria-category">
                            <h6>${cat[`title_${state.currentLang}`]} (${cat.maxPoints} pts max)</h6>
                            <table>
                                <thead>
                                    <tr>
                                        <th>${state.currentLang === 'fr' ? 'Crit√®re' : 'Criteria'}</th>
                                        <th>${state.currentLang === 'fr' ? 'Points Max' : 'Max Points'}</th>
                                        <th>${state.currentLang === 'fr' ? 'Score Obtenu' : 'Score Obtained'}</th>
                                    </tr>
                                </thead>
                                <tbody>
                    `;
                    
                    cat.items.forEach((item, index) => {
                        const score = evaluation.criteria[`crit${criteriaIndex}`] || 0;
                        detailsHTML += `
                            <tr>
                                <td>${item[`text_${state.currentLang}`]}</td>
                                <td>${item.points}</td>
                                <td class="score-cell ${score === item.points ? 'perfect' : score >= item.points * 0.8 ? 'good' : 'needs-improvement'}">${score}</td>
                            </tr>
                        `;
                        criteriaIndex++;
                    });
                    
                    detailsHTML += `
                                </tbody>
                            </table>
                        </div>
                    `;
                }
                
                detailsHTML += '</div>';
                return detailsHTML;
            }
            
            function toggleCriteriaDetails(evaluationId) {
                const detailsDiv = document.getElementById(`criteria-details-${evaluationId}`);
                const iconSpan = document.getElementById(`toggle-icon-${evaluationId}`);
                
                if (detailsDiv.style.display === 'none') {
                    detailsDiv.style.display = 'block';
                    iconSpan.textContent = '‚ñ≤';
                } else {
                    detailsDiv.style.display = 'none';
                    iconSpan.textContent = '‚ñº';
                }
            }
            
            function generateWordReport(evaluationId) {
                const evaluation = EVALUATIONS_DATABASE.find(eval => eval.id === evaluationId);
                if (!evaluation) return;
                
                const performanceLevel = getPerformanceLevel(evaluation.grandTotal);
                const fileName = `Evaluation_${evaluation.teacherName}_${new Date(evaluation.date).toISOString().split('T')[0]}.docx`;
                alert(state.currentLang === 'fr' ? `G√©n√©ration du document Word: ${fileName}\n\nScore: ${evaluation.grandTotal}/100\nNiveau: ${evaluation.performanceLevel || getPerformanceLevel(evaluation.grandTotal)}` : `Generating Word document: ${fileName}\n\nScore: ${evaluation.grandTotal}/100\nLevel: ${evaluation.performanceLevel || getPerformanceLevel(evaluation.grandTotal)}`);
            }
            
            // Expose functions globally for onclick handlers
            window.toggleCriteriaDetails = toggleCriteriaDetails;
            window.generateWordReport = generateWordReport;
            
            // Initial load
            setLanguage('en');
        });
    </script>
</body>
</html>